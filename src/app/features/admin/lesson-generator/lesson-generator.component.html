<div class="min-h-screen surface-ground p-4">
    <div class="card">
        <p-steps [model]="items" [(activeIndex)]="activeIndex" [readonly]="false" styleClass="mb-5"></p-steps>
    </div>

    <div class="container mx-auto max-w-7xl mt-4">

        <!-- Phase 1: Upload & Configure -->
        <div *ngIf="activeIndex === 0">
            <p-card header="Upload & Configure" subheader="Select audio and provide the script">
                <div class="grid formgrid p-fluid">
                    <div class="col-12 md:col-6 mb-4">
                        <h3 class="text-xl font-semibold mb-3">Audio File</h3>
                        <p-fileUpload mode="advanced" chooseLabel="Select Audio" accept="audio/*"
                            [maxFileSize]="50000000" (onSelect)="onAudioSelect($event)" [auto]="true"
                            [customUpload]="true" (uploadHandler)="onUploadHandler($event)">
                            <ng-template pTemplate="content">
                                <div *ngIf="audioFile"
                                    class="flex align-items-center justify-content-center flex-column">
                                    <i class="pi pi-file-audio text-4xl text-primary mb-2"></i>
                                    <span class="font-semibold">{{audioFile.name}}</span>
                                </div>
                                <div *ngIf="!audioFile"
                                    class="flex align-items-center justify-content-center flex-column text-gray-500">
                                    <i class="pi pi-cloud-upload text-4xl mb-2"></i>
                                    <span>Drag and drop audio file here</span>
                                </div>
                            </ng-template>
                        </p-fileUpload>
                    </div>

                    <div class="col-12 md:col-6 mb-4">
                        <h3 class="text-xl font-semibold mb-3">Correct Script</h3>
                        <p-floatLabel>
                            <textarea id="script" rows="10" cols="30" pInputTextarea [(ngModel)]="script"
                                [autoResize]="true" class="w-full" style="min-height: 250px; font-family: monospace;">
                            </textarea>
                            <label for="script">Paste your script here...</label>
                        </p-floatLabel>
                        <small class="block mt-2 text-gray-600">
                            Format: One sentence per line for dialogue, or paragraphs for narrative.
                        </small>
                    </div>
                </div>

                <ng-template pTemplate="footer">
                    <div class="flex justify-content-end gap-2">
                        <button pButton label="Generate Segments" icon="pi pi-cog"
                            [loading]="processingState.isProcessing" [disabled]="!audioFile || !script.trim()"
                            (click)="generateSegments()">
                        </button>
                    </div>

                    <div *ngIf="processingState.isProcessing" class="mt-3">
                        <div class="flex justify-content-between mb-1">
                            <span class="text-primary font-semibold">{{ processingState.currentStep }}</span>
                            <span class="text-primary font-bold">{{ processingState.progress }}%</span>
                        </div>
                        <div class="w-full bg-gray-200 rounded-full h-2.5 dark:bg-gray-700">
                            <div class="bg-primary h-2.5 rounded-full" [style.width.%]="processingState.progress"></div>
                        </div>
                    </div>
                </ng-template>
            </p-card>
        </div>

        <!-- Phase 2: Waveform & Visualization -->
        <div *ngIf="activeIndex === 1">
            <p-panel header="Waveform Visualization">
                <!-- Alignment Warnings Panel -->
                <p-panel *ngIf="alignmentWarnings.length > 0" header="Alignment Warnings" [toggleable]="true"
                    styleClass="mb-4">
                    <div class="bg-yellow-50 border-yellow-200 border-1 border-round p-3">
                        <div class="flex align-items-center mb-2">
                            <i class="pi pi-exclamation-triangle text-yellow-600 mr-2"></i>
                            <strong class="text-yellow-800">{{ alignmentWarnings.length }} words could not be
                                matched</strong>
                        </div>
                        <p class="text-sm text-gray-700 mb-2">
                            These words from your script were not found in the audio transcription.
                        </p>
                        <div class="flex flex-wrap gap-2">
                            <span *ngFor="let word of alignmentWarnings"
                                class="inline-block bg-yellow-100 text-yellow-800 px-2 py-1 rounded text-sm border border-yellow-300">
                                {{ word }}
                            </span>
                        </div>
                    </div>
                </p-panel>

                <p-toolbar styleClass="mb-4">
                    <div class="p-toolbar-group-start">
                        <button pButton icon="pi pi-play" class="mr-2" (click)="togglePlayPause()"
                            pTooltip="Play/Pause"></button>
                        <button pButton icon="pi pi-search-plus" class="mr-2" (click)="zoomIn()"
                            pTooltip="Zoom In"></button>
                        <button pButton icon="pi pi-search-minus" (click)="zoomOut()" pTooltip="Zoom Out"></button>
                    </div>
                    <div class="p-toolbar-group-end">
                        <button pButton label="Next: Edit Segments" icon="pi pi-arrow-right"
                            (click)="activeIndex = 2"></button>
                    </div>
                </p-toolbar>

                <div class="surface-border border-1 border-round p-3 bg-white">
                    <div id="waveform"></div>
                </div>

                <div class="mt-3 text-center text-gray-600">
                    <small>Click on a region to play it. Drag edges to adjust timing.</small>
                </div>
            </p-panel>
        </div>

        <!-- Phase 3: Edit Segments -->
        <div *ngIf="activeIndex === 2">
            <p-card>
                <p-table [value]="segments()" [scrollable]="true" scrollHeight="600px" styleClass="p-datatable-striped"
                    [tableStyle]="{'min-width': '50rem'}">

                    <ng-template pTemplate="header">
                        <tr>
                            <th style="width: 5%">#</th>
                            <th style="width: 25%">Timing (Start - End)</th>
                            <th style="width: 50%">Content</th>
                            <th style="width: 20%">Actions</th>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="body" let-segment let-rowIndex="rowIndex">
                        <tr [class.bg-blue-50]="segment.id === activeSegmentId">
                            <td>
                                <span class="font-bold text-lg text-primary">{{ rowIndex + 1 }}</span>
                            </td>
                            <td>
                                <div class="flex align-items-center gap-2">
                                    <p-inputNumber [(ngModel)]="segment.start" [minFractionDigits]="2"
                                        [maxFractionDigits]="2" [step]="0.1"
                                        (onInput)="updateSegmentTiming(segment.id, +$event.value!, segment.end)"
                                        inputStyleClass="w-6rem text-center">
                                    </p-inputNumber>
                                    <span>-</span>
                                    <p-inputNumber [(ngModel)]="segment.end" [minFractionDigits]="2"
                                        [maxFractionDigits]="2" [step]="0.1"
                                        (onInput)="updateSegmentTiming(segment.id, segment.start, +$event.value!)"
                                        inputStyleClass="w-6rem text-center">
                                    </p-inputNumber>
                                </div>
                                <div class="text-xs text-gray-500 mt-1 text-center">
                                    Duration: {{ (segment.end - segment.start).toFixed(2) }}s
                                </div>
                            </td>
                            <td>
                                <input pInputText type="text" [(ngModel)]="segment.text"
                                    (ngModelChange)="updateSegmentText(segment.id, $event)"
                                    class="w-full font-serif text-lg">
                            </td>
                            <td>
                                <div class="flex gap-2">
                                    <button pButton icon="pi pi-play"
                                        class="p-button-rounded p-button-text p-button-success"
                                        (click)="playSegment(segment.id)" pTooltip="Play Segment">
                                    </button>
                                    <button pButton icon="pi pi-trash"
                                        class="p-button-rounded p-button-text p-button-danger"
                                        (click)="deleteSegment(segment.id)" pTooltip="Delete Segment">
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>

                    <ng-template pTemplate="footer">
                        <tr>
                            <td colspan="4">
                                <div class="flex justify-content-between align-items-center w-full">
                                    <button pButton label="Add New Segment" icon="pi pi-plus" class="p-button-text"
                                        (click)="addNewSegment()">
                                    </button>

                                    <button pButton label="Export Lesson" icon="pi pi-download" class="p-button-success"
                                        (click)="exportJSON()">
                                    </button>
                                </div>
                            </td>
                        </tr>
                    </ng-template>
                </p-table>
            </p-card>
        </div>
    </div>
</div>